<div id="gdpr-consent-banner" i18n:domain="collective.privacy"
     tal:define="portal_state context/@@plone_portal_state;
                 needed view/is_consent_required;
                 portal_url portal_state/portal_url;"
     tal:condition="needed" style="
    width: 100%;
    position: fixed;
    bottom: 0;
    left: 0;
    padding: 5px;
    background: orange;
    display:none;">
    <form method="POST"
          style="max-width: 800px; margin: auto;"
          tal:attributes="action string:${context/portal_privacy/absolute_url}/bannerConsent;
                           data-json-url string:${context/portal_privacy/absolute_url}/@@consent-json">
        <div style="float: left; max-width: 60%;" class="gdpr-reason"></div>
        <div style="float: right; padding-top: 5px;" class="gdpr-actions">
            <input style="padding: 5px; margin-right: 10px;" type="submit" name="consent" value="Allow" i18n:attributes="value"/>
            <input style="padding: 5px; margin-right: 10px;" type="submit" name="refuse" value="Refuse" i18n:attributes="value"/>
        </div>
    </form>
    <div style="clear: both; text-align: center;">
        <a href=""
           tal:attributes="href string:${portal_url}/@@consent"
           i18n:translate="">Manage privacy settings</a>
    </div>
    <script>
        $(function() {
          var reasons = [];
          var submitConsentForm = function(evt) {
            var form = $(this).closest('form');
            var data = form.serialize();
            var url = form.attr('action');
            data += '&'+this.name+'=1';
            $.ajax({
              type: "POST",
              url: url,
              data: data,
            }).done(function() {
              setConsentForm();
            });
            evt.preventDefault();
          };
          var setConsentForm = function() {
            if (reasons.length > 0) {
              $('#gdpr-consent-banner').show();
              var reason = reasons.shift();
              $('#gdpr-consent-banner form .gdpr-reason').html(
                '<strong>' + reason.Title + '</strong>' +
                '<p>' + reason.Description + '</p>' +
                '<input type="hidden" name="processing_reason" value="' + reason.name + '" />'
              );
              $('#gdpr-consent-banner form .gdpr-actions input').on('click', submitConsentForm);
            } else {
              $('#gdpr-consent-banner').remove();
            }
          };
          var url = $('#gdpr-consent-banner form').data('json-url');
          $.ajax({
            type: "GET",
            url: url,
            headers: {"Cache-Control": "no-cache"},
          }).done(function(data) {
            reasons = data;
            setConsentForm();
          });
        });
    </script>
</div>
